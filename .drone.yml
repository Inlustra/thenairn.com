kind: pipeline
name: deployment

trigger:
  branch:
    - master
  event:
    - push

steps:
  - name: deploy
    image: docker/compose:1.23.2
    environment:
      PLEX_CLAIM:
        from_secret: PLEX_CLAIM
      PLEX_ADVERTISE_IP:
        from_secret: PLEX_ADVERTISE_IP
      AZIRE_USERNAME:
        from_secret: AZIRE_USERNAME
      AZIRE_PASSWORD:
        from_secret: AZIRE_PASSWORD
      AZIRE_LOCATION:
        from_secret: AZIRE_LOCATION
      FTP_USER_NAME:
        from_secret: FTP_USER_NAME
      FTP_USER_PASS:
        from_secret: FTP_USER_PASS
    commands:
      - docker-compose up -d --build
    volumes:
      - name: dockersock
        path: /var/run/docker.sock

  - name: deploy-drone
    image: docker/compose:1.23.2
    environment:
      DRONE_GITHUB_CLIENT_ID:
        from_secret: DRONE_GITHUB_CLIENT_ID
      DRONE_GITHUB_CLIENT_SECRET:
        from_secret: DRONE_GITHUB_CLIENT_SECRET
    commands:
      - source .env
      - echo $DRONE_GITHUB_CLIENT_ID
      - echo $DRONE_GITHUB_CLIENT_SECRET
      - docker-compose -f docker-compose.drone.yml up -d --build
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
      - name: drone_env
        path: .env
        


volumes:
  - name: dockersock
    host:
      path: /var/run/docker.sock
  - name: drone_env
    host:
      path: /home/data/config/drone/.env
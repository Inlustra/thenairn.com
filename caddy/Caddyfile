# ROLES DEFINITION

(admin) {
    jwt
}

(superuser) {
    jwt {
        allow roles admin superuser
    }
}

(user) {
    jwt {
        allow roles admin superuser user
    }
}

# SERVER DEFAULTS

{
    order jwt first
}

*.thenairn.com {
    jwt {
        primary yes
        trusted_tokens {
            static_secret {
                token_name access_token
                token_secret {$JWT_SECRET}
                token_issuer {$JWT_ISSUER}
            }
        }
        auth_url "https://auth.thenairn.com/auth/oauth2/google"
        allow roles admin
    }
    tls { 
        on_demand
    }
 }

 # DOMAINS

 auth.thenairn.com {
    route /auth* {
        auth_portal {
            path /auth
            backends {
                google_oauth2_backend {
                    method oauth2
                    realm google
                    provider google
                    client_id {$OAUTH_GOOGLE_CLIENT_ID}
                    client_secret {$OAUTH_GOOGLE_CLIENT_SECRET}
                    
                    scopes openid email profile
                    user thomas@thenairn.com add role admin
                    user tjnairn@gmail.com add role admin
                    user frankiedhazell.fdh@gmail.com add role user
                }
            }
            jwt {
                token_name access_token
                token_secret {$JWT_SECRET}
                token_issuer {$JWT_ISSUER}
                token_lifetime 36000
            }
            cookie_domain thenairn.com
            cookie_path /
        }
    }
 }

transmission.thenairn.com {
    @internal {
        remote_ip 192.168.0.0/16 172.16.0.0/12 10.0.0.0/8
    }
    handle @internal {
        reverse_proxy vpn:9091
    }
    handle {
        import admin
        reverse_proxy vpn:9091
    }
}

http://transmission.thenairn.com {
    @internal {
        remote_ip 192.168.0.0/16 172.16.0.0/12 10.0.0.0/8
    }
    reverse_proxy @internal vpn:9091
}
 
 media.thenairn.com {
    import user
    reverse_proxy organizr:80
}

*.code.thenairn.com {

    tls { 
        on_demand
    }

    reverse_proxy vscode:8443
}


home.thenairn.com {
    reverse_proxy 192.168.96.15:8123
}

frigate.thenairn.com {
    @internal {
        remote_ip 192.168.0.0/16 172.16.0.0/12 10.0.0.0/8
    }
    reverse_proxy @internal frigate:5000
}

unifi.thenairn.com {
    import admin
    reverse_proxy https://192.168.96.15:8443 {
        transport http {
            tls_insecure_skip_verify
        }
    }
}

unraid.thenairn.com {
    import admin
    reverse_proxy host:6059
}

code.thenairn.com {
    import admin
    reverse_proxy vscode:8443
}

download.thenairn.com {
    import admin
    reverse_proxy admin:80
}

radarr.thenairn.com {
    import user
    reverse_proxy radarr:7878
}

jackett.thenairn.com {    
    import superuser
    reverse_proxy vpn:9117
}

asonarr.thenairn.com {    
    import admin
    reverse_proxy asonarr:8989
}

sonarr.thenairn.com {    
    import user
    reverse_proxy sonarr:8989
}

plex.thenairn.com {
    encode gzip
    reverse_proxy plex:32400
}

bazarr.thenairn.com {    
    import user
    reverse_proxy bazarr:6767
}

books.thenairn.com {  
    import user  
    reverse_proxy lazylibrarian:5299
}

library.thenairn.com {   
    import user
    reverse_proxy calibre:8080
}

netdata.thenairn.com {        
    import user
    reverse_proxy netdata:19999
}

monica.thenairn.com {
    reverse_proxy monica:80
}

docs.thenairn.com {
    reverse_proxy mayan:8000
}
